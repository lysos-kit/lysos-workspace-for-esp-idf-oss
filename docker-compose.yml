services:
  esp-idf:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ESPIDF_IMAGE_VERSION: ${ESPIDF_IMAGE_VERSION:-v5.5.1}
    image: esp32-starter-idf:${ESPIDF_IMAGE_VERSION:-v5.5.1}

    # Mount project directory
    volumes:
      - .:/workspace
      - espidf-cargo-cache:/root/.cargo
      - espidf-ccache-cache:/root/.ccache

    # Serial port device passthrough (for WSL2 and Linux)
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0
      - /dev/ttyUSB1:/dev/ttyUSB1

    # Privileged mode for device access (required for WSL2)
    privileged: true

    # Interactive terminal
    stdin_open: true
    tty: true

    # Working directory inside container
    working_dir: /workspace

    # Environment variables from .env file
    environment:
      # ESP-IDF Target Configuration
      - IDF_TARGET=${IDF_TARGET:-esp32s3}

      # Serial Port Configuration
      - ESPPORT=${ESPPORT:-/dev/ttyUSB0}
      - ESPBAUD=${ESPBAUD:-115200}
      - MONITORBAUD=${MONITORBAUD:-115200}

      # Build Configuration
      - IDF_CCACHE_ENABLE=${IDF_CCACHE_ENABLE:-1}
      - CCACHE_DIR=${CCACHE_DIR:-/root/.ccache}
      - CMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE:-Release}
      - IDF_BUILD_PARALLEL=${IDF_BUILD_PARALLEL:-}

      # Monitor Configuration
      - IDF_MONITOR_DECODE=${IDF_MONITOR_DECODE:-1}
      - IDF_MONITOR_BAUD=${IDF_MONITOR_BAUD:-115200}

    # Network mode (useful for debugging and OTA)
    network_mode: bridge

volumes:
  espidf-cargo-cache:
  espidf-ccache-cache:
